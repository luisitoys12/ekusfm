<!DOCTYPE html>
<html lang="es">
<head>
    <title>Estación KUSFM</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="theme-color" content="#453D79">
    
    <!-- Materialize CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    
    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/5db384e8a3.js" crossorigin="anonymous"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #121212;
            color: #FFFFFF;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .img_center {
            max-width: 100%;
            display: block;
            margin: 1rem auto;
        }
        
        .infos_radio {
            background-color: #1E1E1E !important;
            color: #FFFFFF;
            border-radius: 8px;
            padding: 20px 20px 20px 100px !important; /* Más espacio para el avatar */
            position: relative;
            margin: 1rem auto;
            min-height: 80px; /* Asegurar espacio para el avatar */
        }
        
        /* Estilo específico para el avatar de Habbo */
        .habbo-avatar {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 80px;
            height: 80px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center left;
        }
        
        .wrapper_radio {
            background-color: #1E1E1E;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .marquee_wrapper {
            overflow: hidden;
            padding: 8px 0;
        }
        
        .marquee {
            color: #FFFFFF;
            font-size: 16px;
        }
        
        .button_controle {
            background-color: #453D79;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            margin: 5px;
            cursor: pointer;
        }
        
        .button_controle:hover {
            background-color: #7986CB;
        }
        
        #debug {
            margin-top: 20px;
            padding: 10px;
            background-color: #333;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: #0f0;
            display: none;
        }
        
        .debug-visible {
            display: block !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="https://i.imgur.com/ITZcSUM.png" class="img_center" alt="Estación KUSFM Logo">
        
        <!-- DJ/Host Info Card -->
        <div class="card-panel infos_radio" id="infos_radio">
            <!-- Avatar específico de Habbo -->
            <div class="habbo-avatar" id="habbo-avatar"></div>
            
            <span id="locutor">AutoDJ</span> en vivo con "<span id="locutor_programa">Emisión Automática</span>"<br>
            <span id="num_ouvintes">0</span> oyentes conectados.
        </div>
        
        <!-- Main Radio Player -->
        <div class="wrapper_radio z-depth-3">
            <div class="marquee_wrapper">
                <marquee class="marquee" scrolldelay="200" id="marquee_radio">
                    <span>Estación KUSFM - Cargando...</span>
                </marquee>
            </div>
            
            <div class="center-align" style="margin: 15px 0;">
                <button class="button_controle waves-effect" id="btn_control" onclick="togglePlay()">
                    <i id="icon_control" class="fas fa-play"></i>
                </button>
                <button class="button_controle waves-effect" onclick="toggleMute()">
                    <i id="icon_mute" class="fas fa-volume-up"></i>
                </button>
                <button class="button_controle waves-effect" onclick="refreshPlayer()">
                    <i class="fas fa-sync"></i>
                </button>
            </div>
            
            <!-- Volume Slider -->
            <div style="display: flex; align-items: center; margin: 15px 0;">
                <i class="fas fa-volume-down" style="margin-right: 10px;"></i>
                <input type="range" min="0" max="100" value="80" id="volume-slider" style="flex-grow: 1;">
                <i class="fas fa-volume-up" style="margin-left: 10px;"></i>
            </div>
            
            <!-- Audio element -->
            <audio id="player_audio" preload="auto"></audio>
            
            <div style="text-align: center; margin-top: 10px;">
                <button class="waves-effect waves-light btn-small blue" onclick="toggleDebug()">
                    Mostrar diagnóstico
                </button>
            </div>
            
            <!-- Debug panel -->
            <div id="debug"></div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    
    <script>
        // Global variables
        const playerAudio = document.getElementById('player_audio');
        const playButton = document.getElementById('btn_control');
        const playIcon = document.getElementById('icon_control');
        const muteIcon = document.getElementById('icon_mute');
        const volumeSlider = document.getElementById('volume-slider');
        const marqueeRadio = document.getElementById('marquee_radio');
        const debugPanel = document.getElementById('debug');
        const habboAvatar = document.getElementById('habbo-avatar');
        
        // Configuración del reproductor - URL CORREGIDA
        const STREAM_URL = "https://radio.trabullnetwork.pro/listen/estacionkusfm/radio.mp3"; // URL de transmisión actualizada
        
        // Inicializar reproductor
        playerAudio.src = STREAM_URL;
        playerAudio.volume = volumeSlider.value / 100;
        
        // Log de depuración
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugPanel.innerHTML += `[${timestamp}] ${message}<br>`;
            debugPanel.scrollTop = debugPanel.scrollHeight;
        }
        
        // Mostrar/ocultar panel de depuración
        function toggleDebug() {
            debugPanel.classList.toggle('debug-visible');
            if (debugPanel.classList.contains('debug-visible')) {
                log("Panel de diagnóstico activado");
            }
        }
        
        // Reproducir/Pausar
        function togglePlay() {
            log("Intentando reproducir/pausar...");
            
            if (playerAudio.paused) {
                playerAudio.play()
                .then(() => {
                    playIcon.classList.remove('fa-play');
                    playIcon.classList.add('fa-pause');
                    log("Reproducción iniciada");
                })
                .catch(e => {
                    log(`ERROR: ${e.message}`);
                    alert("Error al reproducir. Verifica tu conexión a internet.");
                });
            } else {
                playerAudio.pause();
                playIcon.classList.remove('fa-pause');
                playIcon.classList.add('fa-play');
                log("Reproducción pausada");
            }
        }
        
        // Silenciar/Desilenciar
        function toggleMute() {
            playerAudio.muted = !playerAudio.muted;
            muteIcon.className = playerAudio.muted ? 'fas fa-volume-mute' : 'fas fa-volume-up';
            log(`Audio ${playerAudio.muted ? 'silenciado' : 'con sonido'}`);
        }
        
        // Refrescar reproductor
        function refreshPlayer() {
            log("Refrescando reproductor...");
            playerAudio.load();
            
            if (!playerAudio.paused) {
                playerAudio.play()
                .then(() => log("Reproductor refrescado correctamente"))
                .catch(e => log(`ERROR al refrescar: ${e.message}`));
            }
            
            // Intentar obtener metadata
            fetchNowPlaying();
        }
        
        // Control de volumen
        volumeSlider.addEventListener('input', function() {
            playerAudio.volume = this.value / 100;
            log(`Volumen ajustado a ${this.value}%`);
        });
        
        // Configurar avatar de Habbo.es
        function setHabboAvatar(username = "estacionkusfm") {
            const avatarUrl = `https://www.habbo.es/habbo-imaging/avatarimage?img_format=png&user=${username}&direction=2&head_direction=3&size=l&gesture=sml&action=std`;
            habboAvatar.style.backgroundImage = `url('${avatarUrl}')`;
            log(`Avatar de Habbo.es configurado: ${username}`);
        }
        
        // Obtener información actual
        function fetchNowPlaying() {
            log("Solicitando información de reproducción actual...");
            
            // URL de la API
            const apiUrl = "https://radio.trabullnetwork.pro/api/nowplaying/estacionkusfm";
            
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    log("Respuesta recibida correctamente");
                    return response.json();
                })
                .then(data => {
                    log("Datos procesados correctamente");
                    
                    // Actualizar información en la interfaz
                    const nowPlaying = data.now_playing;
                    marqueeRadio.innerHTML = `<span>Estación KUSFM - ${nowPlaying.song.title} - ${nowPlaying.song.artist}</span>`;
                    
                    // Actualizar información del locutor
                    const locutorName = data.live.is_live ? data.live.streamer_name : "estacionkusfm";
                    document.getElementById('locutor').textContent = data.live.is_live ? data.live.streamer_name : "AutoDJ";
                    document.getElementById('locutor_programa').textContent = data.live.is_live ? "Programa en vivo" : "Emisión Automática";
                    
                    // Actualizar número de oyentes
                    document.getElementById('num_ouvintes').textContent = data.listeners.current;
                    
                    // Configurar avatar de Habbo.es
                    setHabboAvatar(locutorName);
                    
                    log(`Ahora sonando: ${nowPlaying.song.title} - ${nowPlaying.song.artist}`);
                })
                .catch(error => {
                    log(`ERROR: ${error.message}`);
                    marqueeRadio.innerHTML = "<span>Estación KUSFM - Error al cargar información</span>";
                    
                    // Usar configuración por defecto
                    setHabboAvatar("estacionkusfm");
                });
        }
        
        // Manejo de errores del reproductor
        playerAudio.addEventListener('error', function() {
            const errorMessage = playerAudio.error ? `Código: ${playerAudio.error.code}` : 'Error desconocido';
            log(`ERROR de audio: ${errorMessage}`);
            
            playIcon.classList.remove('fa-pause');
            playIcon.classList.add('fa-play');
            
            alert("Error en la transmisión. Intenta refrescar el reproductor.");
        });
        
        // Iniciar automáticamente
        window.addEventListener('DOMContentLoaded', function() {
            log("Página cargada. Inicializando...");
            setHabboAvatar("estacionkusfm"); // Configurar avatar predeterminado
            fetchNowPlaying();
            
            // Actualizar metadata cada 30 segundos
            setInterval(fetchNowPlaying, 30000);
        });
    </script>
</body>
</html>